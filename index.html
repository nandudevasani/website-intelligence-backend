<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Website Intelligence Scanner</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap');

  :root {
    --bg: #0f1117;
    --surface: #1a1d27;
    --surface-hover: #222633;
    --border: #2a2e3b;
    --text: #e4e6ed;
    --text-muted: #8b8fa3;
    --accent: #4f8ff7;
    --accent-glow: rgba(79, 143, 247, 0.15);
    --green: #34d399;
    --red: #f87171;
    --yellow: #fbbf24;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: 'DM Sans', sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    padding: 2rem;
  }

  .container { max-width: 1400px; margin: 0 auto; }

  header { margin-bottom: 2rem; }

  header h1 {
    font-size: 1.75rem;
    font-weight: 700;
    letter-spacing: -0.02em;
    margin-bottom: 0.25rem;
  }

  header h1 span { color: var(--accent); }

  header p { color: var(--text-muted); font-size: 0.9rem; }

  .input-section {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
  }

  .input-section label {
    display: block;
    font-size: 0.8rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--text-muted);
    margin-bottom: 0.5rem;
  }

  textarea {
    width: 100%;
    height: 140px;
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 8px;
    color: var(--text);
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.85rem;
    padding: 0.75rem;
    resize: vertical;
    outline: none;
    transition: border-color 0.2s;
  }

  textarea:focus {
    border-color: var(--accent);
    box-shadow: 0 0 0 3px var(--accent-glow);
  }

  textarea::placeholder { color: var(--text-muted); opacity: 0.6; }

  .domain-count {
    text-align: right;
    font-size: 0.75rem;
    color: var(--text-muted);
    margin-top: 0.35rem;
  }

  .domain-count.over { color: var(--red); font-weight: 600; }

  .btn-row {
    display: flex;
    gap: 0.75rem;
    margin-top: 1rem;
    align-items: center;
  }

  button {
    font-family: 'DM Sans', sans-serif;
    font-weight: 600;
    font-size: 0.85rem;
    padding: 0.6rem 1.25rem;
    border-radius: 8px;
    border: none;
    cursor: pointer;
    transition: all 0.2s;
  }

  .btn-primary {
    background: var(--accent);
    color: #fff;
  }

  .btn-primary:hover {
    background: #3a7ae0;
    transform: translateY(-1px);
    box-shadow: 0 4px 12px var(--accent-glow);
  }

  .btn-primary:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    transform: none;
    box-shadow: none;
  }

  .btn-secondary {
    background: var(--surface-hover);
    color: var(--text);
    border: 1px solid var(--border);
  }

  .btn-secondary:hover { background: var(--border); }

  .btn-danger {
    background: rgba(248, 113, 113, 0.15);
    color: var(--red);
    border: 1px solid rgba(248, 113, 113, 0.3);
  }

  .btn-danger:hover { background: rgba(248, 113, 113, 0.25); }

  #status-msg {
    font-size: 0.85rem;
    color: var(--text-muted);
    margin-left: 0.5rem;
  }

  #status-msg.error { color: var(--red); }
  #status-msg.success { color: var(--green); }

  .progress-bar {
    height: 4px;
    background: var(--border);
    border-radius: 4px;
    overflow: hidden;
    margin-top: 0.75rem;
    display: none;
  }

  .progress-bar.active { display: block; }

  .progress-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--accent), #7c5cfc);
    border-radius: 4px;
    transition: width 0.4s ease;
    width: 0%;
  }

  .info-banner {
    background: rgba(79, 143, 247, 0.08);
    border: 1px solid rgba(79, 143, 247, 0.2);
    border-radius: 8px;
    padding: 0.75rem 1rem;
    margin-bottom: 1.5rem;
    font-size: 0.8rem;
    color: var(--text-muted);
    line-height: 1.5;
  }

  .info-banner strong { color: var(--text); }

  .table-wrap {
    overflow-x: auto;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
  }

  table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.8rem;
  }

  thead th {
    background: var(--surface-hover);
    color: var(--text-muted);
    font-size: 0.7rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.06em;
    padding: 0.75rem 0.6rem;
    text-align: left;
    white-space: nowrap;
    border-bottom: 1px solid var(--border);
    position: sticky;
    top: 0;
    z-index: 1;
  }

  tbody td {
    padding: 0.6rem;
    border-bottom: 1px solid var(--border);
    white-space: nowrap;
    max-width: 200px;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  tbody tr:hover { background: var(--surface-hover); }
  tbody tr:last-child td { border-bottom: none; }

  .badge {
    display: inline-block;
    padding: 0.15rem 0.5rem;
    border-radius: 999px;
    font-size: 0.7rem;
    font-weight: 600;
  }

  .badge-active { background: rgba(52, 211, 153, 0.15); color: var(--green); }
  .badge-inactive { background: rgba(248, 113, 113, 0.15); color: var(--red); }
  .badge-warning { background: rgba(251, 191, 36, 0.15); color: var(--yellow); }

  .social-link {
    color: var(--accent);
    text-decoration: none;
    font-size: 0.75rem;
  }

  .social-link:hover { text-decoration: underline; }

  .empty-state {
    text-align: center;
    padding: 3rem 1rem;
    color: var(--text-muted);
  }

  .spinner {
    display: inline-block;
    width: 14px;
    height: 14px;
    border: 2px solid var(--text-muted);
    border-top-color: var(--accent);
    border-radius: 50%;
    animation: spin 0.6s linear infinite;
    vertical-align: middle;
    margin-right: 6px;
  }

  @keyframes spin { to { transform: rotate(360deg); } }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(4px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .fade-in { animation: fadeIn 0.3s ease forwards; }
</style>
</head>
<body>

<div class="container">
  <header>
    <h1>Website <span>Intelligence</span> Scanner</h1>
    <p>Bulk scan domains for status, business info, and social links</p>
  </header>

  <div class="info-banner">
    <strong>What this scanner detects well:</strong> Domain status, HTTP codes, parked/coming-soon pages.<br>
    <strong>Best-effort (may be empty):</strong> Business name, phone, email, social links — these depend on how each site is built. Sites using React/Vue/Angular often won't show this data since we read raw HTML only.
  </div>

  <div class="input-section">
    <label>Enter domains — one per line (max 50)</label>
    <textarea id="domains" placeholder="example.com&#10;another-site.org&#10;mywebsite.io" oninput="updateCount()"></textarea>
    <div class="domain-count" id="domainCount">0 / 50 domains</div>
    <div class="progress-bar" id="progress"><div class="progress-fill" id="progress-fill"></div></div>
    <div class="btn-row">
      <button class="btn-primary" id="scanBtn" onclick="scanBulk()">Scan Websites</button>
      <button class="btn-secondary" onclick="exportCSV()">Export CSV</button>
      <button class="btn-danger" id="stopBtn" onclick="stopScan()" style="display:none">Stop</button>
      <span id="status-msg"></span>
    </div>
  </div>

  <div class="table-wrap">
    <table id="results">
      <thead>
        <tr>
          <th>#</th>
          <th>Domain</th>
          <th>Status</th>
          <th>Code</th>
          <th>Reason</th>
          <th>Business Name</th>
          <th>Phone</th>
          <th>Email</th>
          <th>Street</th>
          <th>City</th>
          <th>State</th>
          <th>Zip</th>
          <th>Facebook</th>
          <th>Instagram</th>
          <th>LinkedIn</th>
          <th>GMB</th>
        </tr>
      </thead>
      <tbody>
        <tr><td colspan="16" class="empty-state">Enter domains above and click "Scan Websites" to begin</td></tr>
      </tbody>
    </table>
  </div>
</div>

<script>
  // ====== CONFIGURATION ======
  const API_URL = "https://website-intelligence-backend-1.onrender.com";
  const BATCH_SIZE = 1; // One domain per request — guarantees no Render timeout
  const MAX_DOMAINS = 50;

  let scanning = false;
  let abortController = null;

  const scanBtn = document.getElementById("scanBtn");
  const stopBtn = document.getElementById("stopBtn");
  const statusMsg = document.getElementById("status-msg");
  const progress = document.getElementById("progress");
  const progressFill = document.getElementById("progress-fill");

  function updateCount() {
    const lines = document.getElementById("domains").value
      .split("\n").map(d => d.trim()).filter(d => d);
    const countEl = document.getElementById("domainCount");
    countEl.textContent = `${lines.length} / ${MAX_DOMAINS} domains`;
    countEl.className = lines.length > MAX_DOMAINS ? "domain-count over" : "domain-count";
  }

  function setStatus(msg, type = "") {
    statusMsg.textContent = msg;
    statusMsg.className = type;
  }

  function makeSocialLink(url) {
    if (!url) return "—";
    try {
      const hostname = new URL(url).hostname.replace("www.", "");
      return `<a class="social-link" href="${url}" target="_blank" rel="noopener">${hostname}</a>`;
    } catch {
      return `<a class="social-link" href="${url}" target="_blank" rel="noopener">Link</a>`;
    }
  }

  function statusBadge(status, reason) {
    if (status === "Active" && !reason) return `<span class="badge badge-active">Active</span>`;
    if (status === "Active" && reason) return `<span class="badge badge-warning">Warning</span>`;
    return `<span class="badge badge-inactive">Inactive</span>`;
  }

  function addRowToTable(d, index) {
    const tbody = document.querySelector("#results tbody");
    const row = document.createElement("tr");
    row.className = "fade-in";
    row.innerHTML = `
      <td>${index}</td>
      <td><strong>${d.domain}</strong></td>
      <td>${statusBadge(d.status, d.reason)}</td>
      <td>${d.statusCode || "—"}</td>
      <td>${d.reason || "—"}</td>
      <td>${d.name || "—"}</td>
      <td>${d.phone || "—"}</td>
      <td>${d.email ? `<a class="social-link" href="mailto:${d.email}">${d.email}</a>` : "—"}</td>
      <td>${d.street || "—"}</td>
      <td>${d.city || "—"}</td>
      <td>${d.state || "—"}</td>
      <td>${d.zip || "—"}</td>
      <td>${makeSocialLink(d.social?.facebook)}</td>
      <td>${makeSocialLink(d.social?.instagram)}</td>
      <td>${makeSocialLink(d.social?.linkedin)}</td>
      <td>${makeSocialLink(d.social?.gmb)}</td>
    `;
    tbody.appendChild(row);
  }

  function stopScan() {
    if (abortController) abortController.abort();
    scanning = false;
    stopBtn.style.display = "none";
    scanBtn.disabled = false;
    setStatus("⛔ Scan stopped", "error");
  }

  async function scanBulk() {
    const domains = document.getElementById("domains").value
      .split("\n")
      .map(d => d.trim().replace(/^https?:\/\//, "").replace(/\/+$/, ""))
      .filter(d => d);

    if (!domains.length) return alert("Enter at least one domain");

    if (domains.length > MAX_DOMAINS) {
      return alert(`Maximum ${MAX_DOMAINS} domains per scan. You entered ${domains.length}.`);
    }

    const tbody = document.querySelector("#results tbody");
    tbody.innerHTML = "";

    scanning = true;
    abortController = new AbortController();
    scanBtn.disabled = true;
    stopBtn.style.display = "inline-block";
    progress.classList.add("active");
    progressFill.style.width = "5%";

    setStatus("⏳ Waking up server (may take 30-60s on first request)...", "");

    try {
      // Health check — wake up Render
      const healthCheck = await fetch(API_URL + "/", {
        signal: AbortSignal.timeout(90000)
      });

      if (!healthCheck.ok) throw new Error("Server health check failed");

      setStatus("⏳ Server is up! Starting scan...", "");
      progressFill.style.width = "10%";

      // Scan domains 3 at a time, one domain per request
      const PARALLEL = 3;
      let completed = 0;
      let totalActive = 0;
      let rowIndex = 0;

      for (let i = 0; i < domains.length; i += PARALLEL) {
        if (!scanning) break;

        const chunk = domains.slice(i, i + PARALLEL);
        setStatus(`⏳ Scanning ${completed + 1}-${Math.min(completed + chunk.length, domains.length)} of ${domains.length}...`, "");

        // Fire all requests in this chunk simultaneously
        const promises = chunk.map(async (domain) => {
          try {
            const res = await fetch(API_URL + "/batch-scan", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ domains: [domain] }),
              signal: abortController.signal
            });

            const text = await res.text();
            if (!res.ok) throw new Error(`HTTP ${res.status}`);

            let data;
            try { data = JSON.parse(text); } catch { throw new Error("Bad response"); }

            if (Array.isArray(data) && data.length > 0) {
              return data[0];
            }
            throw new Error("Empty response");
          } catch (err) {
            if (err.name === "AbortError") throw err;
            return {
              domain,
              status: "Inactive",
              statusCode: 0,
              reason: `Error: ${err.message}`,
              name: "", phone: "", email: "", street: "", city: "", state: "", zip: "",
              social: { facebook: "", instagram: "", linkedin: "", gmb: "" }
            };
          }
        });

        try {
          const results = await Promise.all(promises);
          results.forEach(d => {
            rowIndex++;
            addRowToTable(d, rowIndex);
            if (d.status === "Active") totalActive++;
          });
        } catch (err) {
          if (err.name === "AbortError") break;
        }

        completed += chunk.length;
        const pct = 10 + (completed / domains.length) * 85;
        progressFill.style.width = pct + "%";
      }
      }

      progressFill.style.width = "100%";

      if (scanning) {
        setStatus(`✅ Done! ${totalActive}/${domains.length} active`, "success");
      }

    } catch (err) {
      if (err.name !== "AbortError") {
        console.error("Scan error:", err);
        tbody.innerHTML = `<tr><td colspan="16" class="empty-state" style="color:var(--red)">
          ❌ Error: ${err.message}<br><br>
          <span style="font-size:0.75rem; color:var(--text-muted)">
            If this is a timeout, your Render server may be starting up. Wait 60 seconds and try again.
          </span>
        </td></tr>`;
        setStatus("Error — see details below", "error");
      }
    } finally {
      scanning = false;
      scanBtn.disabled = false;
      stopBtn.style.display = "none";
      setTimeout(() => {
        progress.classList.remove("active");
        progressFill.style.width = "0%";
      }, 1500);
    }
  }

  function exportCSV() {
    const rows = Array.from(document.querySelectorAll("#results tr"));
    if (rows.length <= 1) return alert("No data to export");

    const csv = rows.map(r =>
      Array.from(r.cells).map(c => `"${c.innerText.replace(/"/g, '""')}"`).join(",")
    ).join("\n");

    const blob = new Blob(["\uFEFF" + csv], { type: "text/csv;charset=utf-8;" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = `scan-results-${new Date().toISOString().slice(0, 10)}.csv`;
    a.click();
    URL.revokeObjectURL(a.href);
  }
</script>

</body>
</html>
