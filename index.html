<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Website Intelligence Scanner</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap');

  :root {
    --bg: #0f1117;
    --surface: #1a1d27;
    --surface-hover: #222633;
    --border: #2a2e3b;
    --text: #e4e6ed;
    --text-muted: #8b8fa3;
    --accent: #4f8ff7;
    --accent-glow: rgba(79, 143, 247, 0.15);
    --green: #34d399;
    --red: #f87171;
    --yellow: #fbbf24;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: 'DM Sans', sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    padding: 2rem;
  }

  .container { max-width: 1400px; margin: 0 auto; }
  header { margin-bottom: 2rem; }

  header h1 {
    font-size: 1.75rem;
    font-weight: 700;
    letter-spacing: -0.02em;
    margin-bottom: 0.25rem;
  }

  header h1 span { color: var(--accent); }
  header p { color: var(--text-muted); font-size: 0.9rem; }

  .input-section {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
  }

  .input-section label {
    display: block;
    font-size: 0.8rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--text-muted);
    margin-bottom: 0.5rem;
  }

  textarea {
    width: 100%;
    height: 140px;
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 8px;
    color: var(--text);
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.85rem;
    padding: 0.75rem;
    resize: vertical;
    outline: none;
    transition: border-color 0.2s;
  }

  textarea:focus {
    border-color: var(--accent);
    box-shadow: 0 0 0 3px var(--accent-glow);
  }

  textarea::placeholder { color: var(--text-muted); opacity: 0.6; }

  .domain-count {
    text-align: right;
    font-size: 0.75rem;
    color: var(--text-muted);
    margin-top: 0.35rem;
  }

  .domain-count.over { color: var(--red); font-weight: 600; }

  .btn-row {
    display: flex;
    gap: 0.75rem;
    margin-top: 1rem;
    align-items: center;
  }

  button {
    font-family: 'DM Sans', sans-serif;
    font-weight: 600;
    font-size: 0.85rem;
    padding: 0.6rem 1.25rem;
    border-radius: 8px;
    border: none;
    cursor: pointer;
    transition: all 0.2s;
  }

  .btn-primary { background: var(--accent); color: #fff; }

  .btn-primary:hover {
    background: #3a7ae0;
    transform: translateY(-1px);
    box-shadow: 0 4px 12px var(--accent-glow);
  }

  .btn-primary:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    transform: none;
    box-shadow: none;
  }

  .btn-secondary {
    background: var(--surface-hover);
    color: var(--text);
    border: 1px solid var(--border);
  }

  .btn-secondary:hover { background: var(--border); }

  .btn-danger {
    background: rgba(248, 113, 113, 0.15);
    color: var(--red);
    border: 1px solid rgba(248, 113, 113, 0.3);
  }

  .btn-danger:hover { background: rgba(248, 113, 113, 0.25); }

  #status-msg {
    font-size: 0.85rem;
    color: var(--text-muted);
    margin-left: 0.5rem;
  }

  #status-msg.error { color: var(--red); }
  #status-msg.success { color: var(--green); }

  .progress-bar {
    height: 4px;
    background: var(--border);
    border-radius: 4px;
    overflow: hidden;
    margin-top: 0.75rem;
    display: none;
  }

  .progress-bar.active { display: block; }

  .progress-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--accent), #7c5cfc);
    border-radius: 4px;
    transition: width 0.4s ease;
    width: 0%;
  }

  .info-banner {
    background: rgba(79, 143, 247, 0.08);
    border: 1px solid rgba(79, 143, 247, 0.2);
    border-radius: 8px;
    padding: 0.75rem 1rem;
    margin-bottom: 1.5rem;
    font-size: 0.8rem;
    color: var(--text-muted);
    line-height: 1.5;
  }

  .info-banner strong { color: var(--text); }

  .table-wrap {
    overflow-x: auto;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
  }

  table { width: 100%; border-collapse: collapse; font-size: 0.8rem; }

  thead th {
    background: var(--surface-hover);
    color: var(--text-muted);
    font-size: 0.7rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.06em;
    padding: 0.75rem 0.6rem;
    text-align: left;
    white-space: nowrap;
    border-bottom: 1px solid var(--border);
    position: sticky;
    top: 0;
    z-index: 1;
  }

  tbody td {
    padding: 0.6rem;
    border-bottom: 1px solid var(--border);
    white-space: nowrap;
    max-width: 200px;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  tbody tr:hover { background: var(--surface-hover); }
  tbody tr:last-child td { border-bottom: none; }

  .badge {
    display: inline-block;
    padding: 0.15rem 0.5rem;
    border-radius: 999px;
    font-size: 0.7rem;
    font-weight: 600;
  }

  .badge-active { background: rgba(52, 211, 153, 0.15); color: var(--green); }
  .badge-inactive { background: rgba(248, 113, 113, 0.15); color: var(--red); }
  .badge-warning { background: rgba(251, 191, 36, 0.15); color: var(--yellow); }

  .social-link { color: var(--accent); text-decoration: none; font-size: 0.75rem; }
  .social-link:hover { text-decoration: underline; }

  .empty-state { text-align: center; padding: 3rem 1rem; color: var(--text-muted); }

  .spinner {
    display: inline-block;
    width: 14px;
    height: 14px;
    border: 2px solid var(--text-muted);
    border-top-color: var(--accent);
    border-radius: 50%;
    animation: spin 0.6s linear infinite;
    vertical-align: middle;
    margin-right: 6px;
  }

  @keyframes spin { to { transform: rotate(360deg); } }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(4px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .fade-in { animation: fadeIn 0.3s ease forwards; }
</style>
</head>
<body>

<div class="container">
  <header>
    <h1>Website <span>Intelligence</span> Scanner</h1>
    <p>Bulk scan domains for status, business info, and social links</p>
  </header>

  <div class="info-banner">
    <strong>Reliable:</strong> Domain status, HTTP codes, parked/coming-soon detection.<br>
    <strong>Best-effort (may be empty):</strong> Business name, phone, email, social links — depends on how each site is built.
  </div>

  <div class="input-section">
    <label>Enter domains — one per line (max 50)</label>
    <textarea id="domains" placeholder="google.com&#10;github.com&#10;example.com"></textarea>
    <div class="domain-count" id="domainCount">0 / 50 domains</div>
    <div class="progress-bar" id="progress"><div class="progress-fill" id="progress-fill"></div></div>
    <div class="btn-row">
      <button class="btn-primary" id="scanBtn">Scan Websites</button>
      <button class="btn-secondary" id="exportBtn">Export CSV</button>
      <button class="btn-danger" id="stopBtn" style="display:none">Stop</button>
      <span id="status-msg"></span>
    </div>
  </div>

  <div class="table-wrap">
    <table id="results">
      <thead>
        <tr>
          <th>#</th>
          <th>Domain</th>
          <th>Status</th>
          <th>Code</th>
          <th>Reason</th>
          <th>Business Name</th>
          <th>Phone</th>
          <th>Email</th>
          <th>Street</th>
          <th>City</th>
          <th>State</th>
          <th>Zip</th>
          <th>Facebook</th>
          <th>Instagram</th>
          <th>LinkedIn</th>
          <th>GMB</th>
        </tr>
      </thead>
      <tbody>
        <tr><td colspan="16" class="empty-state">Enter domains above and click "Scan Websites" to begin</td></tr>
      </tbody>
    </table>
  </div>
</div>

<script>
  // ====== CONFIGURATION ======
  var API_URL = "https://website-intelligence-backend-1.onrender.com";
  var MAX_DOMAINS = 50;
  var PARALLEL = 3;

  var scanning = false;
  var abortController = null;

  var scanBtn = document.getElementById("scanBtn");
  var stopBtn = document.getElementById("stopBtn");
  var exportBtn = document.getElementById("exportBtn");
  var statusMsg = document.getElementById("status-msg");
  var progress = document.getElementById("progress");
  var progressFill = document.getElementById("progress-fill");
  var domainsInput = document.getElementById("domains");

  // Attach event listeners
  scanBtn.addEventListener("click", scanBulk);
  stopBtn.addEventListener("click", stopScan);
  exportBtn.addEventListener("click", exportCSV);
  domainsInput.addEventListener("input", updateCount);

  function updateCount() {
    var lines = domainsInput.value.split("\n").map(function(d) { return d.trim(); }).filter(function(d) { return d; });
    var countEl = document.getElementById("domainCount");
    countEl.textContent = lines.length + " / " + MAX_DOMAINS + " domains";
    countEl.className = lines.length > MAX_DOMAINS ? "domain-count over" : "domain-count";
  }

  function setStatus(msg, type) {
    statusMsg.textContent = msg;
    statusMsg.className = type || "";
  }

  function makeSocialLink(url) {
    if (!url) return "\u2014";
    try {
      var hostname = new URL(url).hostname.replace("www.", "");
      return '<a class="social-link" href="' + url + '" target="_blank" rel="noopener">' + hostname + '</a>';
    } catch (e) {
      return '<a class="social-link" href="' + url + '" target="_blank" rel="noopener">Link</a>';
    }
  }

  function statusBadge(status, reason) {
    if (status === "Active" && !reason) return '<span class="badge badge-active">Active</span>';
    if (status === "Active" && reason) return '<span class="badge badge-warning">Warning</span>';
    return '<span class="badge badge-inactive">Inactive</span>';
  }

  function escapeHtml(str) {
    if (!str) return "";
    return str.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;");
  }

  function addRowToTable(d, index) {
    var tbody = document.querySelector("#results tbody");
    var row = document.createElement("tr");
    row.className = "fade-in";

    var email = d.email || "";
    var emailCell = email ? '<a class="social-link" href="mailto:' + escapeHtml(email) + '">' + escapeHtml(email) + '</a>' : "\u2014";
    var social = d.social || {};

    row.innerHTML =
      '<td>' + index + '</td>' +
      '<td><strong>' + escapeHtml(d.domain) + '</strong></td>' +
      '<td>' + statusBadge(d.status, d.reason) + '</td>' +
      '<td>' + (d.statusCode || "\u2014") + '</td>' +
      '<td>' + (escapeHtml(d.reason) || "\u2014") + '</td>' +
      '<td>' + (escapeHtml(d.name) || "\u2014") + '</td>' +
      '<td>' + (escapeHtml(d.phone) || "\u2014") + '</td>' +
      '<td>' + emailCell + '</td>' +
      '<td>' + (escapeHtml(d.street) || "\u2014") + '</td>' +
      '<td>' + (escapeHtml(d.city) || "\u2014") + '</td>' +
      '<td>' + (escapeHtml(d.state) || "\u2014") + '</td>' +
      '<td>' + (escapeHtml(d.zip) || "\u2014") + '</td>' +
      '<td>' + makeSocialLink(social.facebook) + '</td>' +
      '<td>' + makeSocialLink(social.instagram) + '</td>' +
      '<td>' + makeSocialLink(social.linkedin) + '</td>' +
      '<td>' + makeSocialLink(social.gmb) + '</td>';

    tbody.appendChild(row);
  }

  function stopScan() {
    if (abortController) {
      abortController.abort();
    }
    scanning = false;
    stopBtn.style.display = "none";
    scanBtn.disabled = false;
    setStatus("Scan stopped", "error");
  }

  // Scan a single domain via the API
  function scanOneDomain(domain, signal) {
    return fetch(API_URL + "/batch-scan", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ domains: [domain] }),
      signal: signal
    })
    .then(function(res) {
      return res.text().then(function(text) {
        if (!res.ok) {
          throw new Error("HTTP " + res.status);
        }
        try {
          var data = JSON.parse(text);
          if (Array.isArray(data) && data.length > 0) {
            return data[0];
          }
          throw new Error("Empty");
        } catch (e) {
          throw new Error("Bad response");
        }
      });
    })
    .catch(function(err) {
      if (err.name === "AbortError") throw err;
      return {
        domain: domain,
        status: "Inactive",
        statusCode: 0,
        reason: "Error: " + err.message,
        name: "", phone: "", email: "", street: "", city: "", state: "", zip: "",
        social: { facebook: "", instagram: "", linkedin: "", gmb: "" }
      };
    });
  }

  function scanBulk() {
    var raw = domainsInput.value.split("\n");
    var domains = [];
    for (var i = 0; i < raw.length; i++) {
      var d = raw[i].trim().replace(/^https?:\/\//, "").replace(/\/+$/, "");
      if (d) domains.push(d);
    }

    if (domains.length === 0) {
      alert("Enter at least one domain");
      return;
    }

    if (domains.length > MAX_DOMAINS) {
      alert("Maximum " + MAX_DOMAINS + " domains per scan. You entered " + domains.length + ".");
      return;
    }

    var tbody = document.querySelector("#results tbody");
    tbody.innerHTML = "";

    scanning = true;
    abortController = new AbortController();
    scanBtn.disabled = true;
    stopBtn.style.display = "inline-block";
    progress.classList.add("active");
    progressFill.style.width = "5%";

    setStatus("Waking up server (may take 30-60s on first request)...", "");

    // Step 1: Health check to wake Render
    var healthTimeout = setTimeout(function() {}, 0);
    fetch(API_URL + "/", { signal: abortController.signal })
    .then(function(res) {
      if (!res.ok) throw new Error("Server health check failed");

      setStatus("Server is up! Scanning...", "");
      progressFill.style.width = "10%";

      // Step 2: Scan domains, PARALLEL at a time
      var completed = 0;
      var totalActive = 0;
      var rowIndex = 0;
      var idx = 0;

      function scanNextChunk() {
        if (!scanning || idx >= domains.length) {
          // Done
          progressFill.style.width = "100%";
          if (scanning) {
            setStatus("Done! " + totalActive + "/" + domains.length + " active", "success");
          }
          scanning = false;
          scanBtn.disabled = false;
          stopBtn.style.display = "none";
          setTimeout(function() {
            progress.classList.remove("active");
            progressFill.style.width = "0%";
          }, 1500);
          return;
        }

        // Grab next chunk of PARALLEL domains
        var chunk = domains.slice(idx, idx + PARALLEL);
        idx += chunk.length;

        setStatus("Scanning " + (completed + 1) + "-" + Math.min(completed + chunk.length, domains.length) + " of " + domains.length + "...", "");

        // Fire all requests in parallel
        var promises = [];
        for (var j = 0; j < chunk.length; j++) {
          promises.push(scanOneDomain(chunk[j], abortController.signal));
        }

        Promise.all(promises)
        .then(function(results) {
          for (var k = 0; k < results.length; k++) {
            rowIndex++;
            addRowToTable(results[k], rowIndex);
            if (results[k].status === "Active") totalActive++;
          }
          completed += chunk.length;
          var pct = 10 + (completed / domains.length) * 85;
          progressFill.style.width = pct + "%";

          // Scan next chunk
          scanNextChunk();
        })
        .catch(function(err) {
          if (err.name === "AbortError") {
            setStatus("Scan stopped", "error");
            scanning = false;
            scanBtn.disabled = false;
            stopBtn.style.display = "none";
            return;
          }
          // Continue with next chunk even if this one errored
          completed += chunk.length;
          scanNextChunk();
        });
      }

      // Start scanning
      scanNextChunk();
    })
    .catch(function(err) {
      if (err.name === "AbortError") return;
      console.error("Health check error:", err);
      tbody.innerHTML = '<tr><td colspan="16" class="empty-state" style="color:var(--red)">' +
        'Error: ' + err.message + '<br><br>' +
        '<span style="font-size:0.75rem; color:var(--text-muted)">' +
        'Your Render server may be starting up. Wait 60 seconds and try again.' +
        '</span></td></tr>';
      setStatus("Error — see details below", "error");
      scanning = false;
      scanBtn.disabled = false;
      stopBtn.style.display = "none";
      progress.classList.remove("active");
    });
  }

  function exportCSV() {
    var rows = document.querySelectorAll("#results tr");
    if (rows.length <= 1) {
      alert("No data to export");
      return;
    }

    var lines = [];
    for (var i = 0; i < rows.length; i++) {
      var cells = rows[i].cells;
      var line = [];
      for (var j = 0; j < cells.length; j++) {
        line.push('"' + cells[j].innerText.replace(/"/g, '""') + '"');
      }
      lines.push(line.join(","));
    }

    var csv = lines.join("\n");
    var blob = new Blob(["\uFEFF" + csv], { type: "text/csv;charset=utf-8;" });
    var a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "scan-results-" + new Date().toISOString().slice(0, 10) + ".csv";
    a.click();
    URL.revokeObjectURL(a.href);
  }
</script>

</body>
</html>
